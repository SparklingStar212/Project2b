<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pronunciation Check</title>
  <link rel="icon" href="../images/favicon.png" type="image/png">
</head>

<body>

  <audio id="wordAudio" controls>
    <source src="../Audio/Single vowel/kr-m-zy-a.mp3" type="audio/mpeg">
  </audio>

  <button id="playAudio">‚ñ∂Ô∏è Play Pronunciation</button>
  <button id="micBtn">üé§ Speak</button>

  <p id="userSpoken"></p>
  <p id="resultMessage"></p>

  <script>
    document.getElementById("playAudio").onclick = () => {
      document.getElementById("wordAudio").play();
    };

    const targetWord = "ÏïÑ"; // vowel
    const isShort = targetWord.length <= 1;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // Load native audio
    async function loadNativeAudio(url) {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      return audioBuffer.getChannelData(0); // mono channel
    }

    // Normalize audio data between -1 and 1
    function normalizeAudio(data) {
      const max = Math.max(...data.map(Math.abs));
      return data.map(v => v / max);
    }

    // Cross-correlation similarity (0 = different, 1 = identical)
    function crossCorrelationSimilarity(nativeData, userData) {
      const minLength = Math.min(nativeData.length, userData.length);
      let sum = 0;
      for (let i = 0; i < minLength; i++) {
        sum += nativeData[i] * userData[i];
      }
      const normNative = Math.sqrt(nativeData.slice(0, minLength).reduce((a, b) => a + b * b, 0));
      const normUser = Math.sqrt(userData.slice(0, minLength).reduce((a, b) => a + b * b, 0));
      return sum / (normNative * normUser);
    }

    // Record user audio
    async function recordAndCompare() {
      const nativeDataRaw = await loadNativeAudio("../Audio/Single vowel/kr-m-zy-a.mp3");
      const nativeData = normalizeAudio(nativeDataRaw);

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      const audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const userBlob = new Blob(audioChunks);
        const arrayBuffer = await userBlob.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        const userData = normalizeAudio(audioBuffer.getChannelData(0));

        const similarity = crossCorrelationSimilarity(nativeData, userData);
        const percent = Math.round(similarity * 100);

        if (percent > 80) {
          document.getElementById("resultMessage").textContent = `‚úÖ Excellent! Similarity: ${percent}%`;
        } else if (percent > 60) {
          document.getElementById("resultMessage").textContent = `üü° Almost there! Similarity: ${percent}%`;
        } else {
          document.getElementById("resultMessage").textContent = `‚ùå Try again! Similarity: ${percent}%`;
        }
      };

      mediaRecorder.start();
      document.getElementById("resultMessage").textContent = "Recording... speak now!";
      setTimeout(() => mediaRecorder.stop(), 1500);
    }

    // Text-based check for long words
    function levenshtein(a, b) {
      const matrix = [];
      for (let i = 0; i <= b.length; i++) matrix[i] = [i];
      for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          matrix[i][j] = b[i - 1] === a[j - 1] ? matrix[i - 1][j - 1] :
            Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
        }
      }
      return matrix[b.length][a.length];
    }

    function checkTextPronunciation(userSpeech) {
      const distance = levenshtein(userSpeech, targetWord);
      const similarity = 1 - distance / Math.max(userSpeech.length, targetWord.length);

      if (similarity >= 0.8) {
        document.getElementById("resultMessage").textContent = "‚úÖ Perfect pronunciation!";
      } else if (similarity >= 0.6) {
        document.getElementById("resultMessage").textContent = "üü° Almost there!";
      } else {
        document.getElementById("resultMessage").textContent = "‚ùå Try again!";
      }
    }

    // Main button
    document.getElementById("micBtn").onclick = () => {
      if (isShort) {
        recordAndCompare();
      } else {
        if (!('webkitSpeechRecognition' in window)) return alert("Browser not supported");
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "ko-KR";
        recognition.interimResults = false;
        recognition.maxAlternatives = 3;
        recognition.continuous = false;

        recognition.onresult = (event) => {
          const spokenText = event.results[0][0].transcript;
          document.getElementById("userSpoken").textContent = "You said: " + spokenText;
          checkTextPronunciation(spokenText);
          recognition.stop();
        };

        recognition.onerror = (event) => {
          document.getElementById("resultMessage").textContent = "‚ùå Error: " + event.error;
          recognition.stop();
        };

        recognition.start();
        document.getElementById("resultMessage").textContent = "Listening...";
      }
    };
  </script>
</body>

</html>